name: AgendaApp CI/CD

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
    
    - name: Authenticate to Google Cloud
      uses: google-github-actions/auth@v1
      with:
        credentials_json: ${{ secrets.GCP_SA_KEY }}
        project_id: kubernetes-474008
    
    - name: Setup Google Cloud CLI
      uses: google-github-actions/setup-gcloud@v1
    
    - name: Configure Docker for Artifact Registry
      run: |
        gcloud auth configure-docker us-central1-docker.pkg.dev --quiet
        echo "Docker configured for Artifact Registry"
    
    - name: Build Backend Image
      run: |
        cd AgendaApp/backend
        docker build -t us-central1-docker.pkg.dev/kubernetes-474008/agendaapp/backend:${{ github.sha }} .
    
    - name: Build Frontend Image
      run: |
        cd AgendaApp/frontend
        docker build -t us-central1-docker.pkg.dev/kubernetes-474008/agendaapp/frontend:${{ github.sha }} .
    
    - name: Push Images
      run: |
        docker push us-central1-docker.pkg.dev/kubernetes-474008/agendaapp/backend:${{ github.sha }}
        docker push us-central1-docker.pkg.dev/kubernetes-474008/agendaapp/frontend:${{ github.sha }}
    
    - name: Deploy to GKE
      run: |
        gcloud container clusters get-credentials agendaapp-cluster --region us-central1
        
        # Update backend
        kubectl set image deployment/backend-postgres backend=us-central1-docker.pkg.dev/kubernetes-474008/agendaapp/backend:${{ github.sha }}
        
        # Update frontend  
        kubectl set image deployment/frontend frontend=us-central1-docker.pkg.dev/kubernetes-474008/agendaapp/frontend:${{ github.sha }}
        
        # Wait for rollout
        kubectl rollout status deployment/backend-postgres
        kubectl rollout status deployment/frontend
    
    - name: Verify Deployment
      run: |
        kubectl get pods
        kubectl get services