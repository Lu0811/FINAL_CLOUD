name: AgendaApp CI/CD

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
    
    - name: Authenticate to Google Cloud
      uses: google-github-actions/auth@v1
      with:
        credentials_json: ${{ secrets.GCP_SA_KEY }}
        project_id: kubernetes-474008
    
    - name: Setup Google Cloud CLI
      uses: google-github-actions/setup-gcloud@v1
      with:
        install_components: 'gke-gcloud-auth-plugin'
    
    - name: Configure Docker for Artifact Registry
      run: |
        gcloud auth configure-docker us-central1-docker.pkg.dev --quiet
        echo "Docker configured for Artifact Registry"
    
    - name: Build Backend Image
      run: |
        cd AgendaApp/backend
        docker build -t us-central1-docker.pkg.dev/kubernetes-474008/agendaapp/backend:${{ github.sha }} .
    
    - name: Build Frontend Image
      run: |
        cd AgendaApp/frontend
        docker build -t us-central1-docker.pkg.dev/kubernetes-474008/agendaapp/frontend:${{ github.sha }} .
    
    - name: Push Images
      run: |
        docker push us-central1-docker.pkg.dev/kubernetes-474008/agendaapp/backend:${{ github.sha }}
        docker push us-central1-docker.pkg.dev/kubernetes-474008/agendaapp/frontend:${{ github.sha }}
    
    - name: Deploy to GKE
      env:
        USE_GKE_GCLOUD_AUTH_PLUGIN: True
      run: |
        echo "Getting GKE credentials..."
        gcloud container clusters get-credentials agendaapp-cluster --region us-central1 --project kubernetes-474008
        
        echo "Verifying kubectl connection..."
        kubectl get nodes
        
        echo "Updating backend deployment..."
        kubectl set image deployment/backend-postgres backend=us-central1-docker.pkg.dev/kubernetes-474008/agendaapp/backend:${{ github.sha }} --record
        
        echo "Updating frontend deployment..."
        kubectl set image deployment/frontend frontend=us-central1-docker.pkg.dev/kubernetes-474008/agendaapp/frontend:${{ github.sha }} --record
        
        echo "Waiting for rollout to complete..."
        kubectl rollout status deployment/backend-postgres --timeout=300s
        kubectl rollout status deployment/frontend --timeout=300s
    
    - name: Verify Deployment
      run: |
        kubectl get pods
        kubectl get services