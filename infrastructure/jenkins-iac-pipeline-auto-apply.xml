<?xml version='1.1' encoding='UTF-8'?>
<flow-definition plugin="workflow-job@2.40">
  <description>Pipeline autom√°tico para aplicar cambios IaC con OpenTofu</description>
  <keepDependencies>false</keepDependencies>
  <properties/>
  <definition class="org.jenkinsci.plugins.workflow.cps.CpsFlowDefinition" plugin="workflow-cps@2.93">
    <script><![CDATA[pipeline {
    agent any
    
    environment {
        GCP_PROJECT = 'kubernetes-474008'
        GCP_REGION = 'us-central1'
        TOFU_DIR = '/workspace/infrastructure/opentofu'
        CLOUDSDK_PYTHON = '/usr/bin/python3'
    }
    
    stages {
        stage('üîß Preparar Entorno') {
            steps {
                echo '=== Configurando entorno para OpenTofu ==='
                sh '''
                    echo "üì¶ Verificando herramientas instaladas..."
                    tofu version || echo "‚ö†Ô∏è  OpenTofu no encontrado"
                    gcloud version || echo "‚ö†Ô∏è  gcloud no encontrado"
                    echo ""
                    echo "‚úÖ Entorno preparado"
                '''
            }
        }
        
        stage('üîê Autenticar GCP') {
            steps {
                echo '=== Autenticando con Google Cloud ==='
                withCredentials([file(credentialsId: 'gcp-jenkins-iac-credentials', variable: 'GCP_KEY_FILE')]) {
                    sh '''
                        echo "üîë Activando Service Account..."
                        gcloud auth activate-service-account --key-file=$GCP_KEY_FILE
                        gcloud config set project ${GCP_PROJECT}
                        
                        echo ""
                        echo "‚úÖ Autenticaci√≥n exitosa"
                        echo "üìã Proyecto activo: ${GCP_PROJECT}"
                    '''
                }
            }
        }
        
        stage('üì• Clonar Repositorio IaC') {
            steps {
                echo '=== Obteniendo c√≥digo de infraestructura ==='
                sh '''
                    # En un entorno real, clonar√≠as desde Git
                    # git clone <repo-url> ${TOFU_DIR}
                    
                    echo "üìÇ Directorio de trabajo: ${TOFU_DIR}"
                    echo "‚úÖ C√≥digo IaC obtenido"
                '''
            }
        }
        
        stage('üîÑ Inicializar OpenTofu') {
            steps {
                echo '=== Inicializando OpenTofu ==='
                dir("${TOFU_DIR}") {
                    sh '''
                        tofu init -reconfigure
                        echo ""
                        echo "‚úÖ OpenTofu inicializado"
                    '''
                }
            }
        }
        
        stage('üîç Validar Configuraci√≥n') {
            steps {
                echo '=== Validando sintaxis de archivos HCL ==='
                dir("${TOFU_DIR}") {
                    sh '''
                        tofu validate
                        echo ""
                        echo "‚úÖ Configuraci√≥n validada correctamente"
                    '''
                }
            }
        }
        
        stage('üìä Generar Plan') {
            steps {
                echo '=== Generando plan de cambios ==='
                dir("${TOFU_DIR}") {
                    sh '''
                        tofu plan -var-file=environments/dev/terraform.tfvars -out=tfplan
                        echo ""
                        echo "‚úÖ Plan generado y guardado como 'tfplan'"
                    '''
                }
            }
        }
        
        stage('‚ö° Aplicar Cambios') {
            steps {
                echo '=== Aplicando cambios de infraestructura ==='
                dir("${TOFU_DIR}") {
                    sh '''
                        echo "üöÄ Ejecutando tofu apply..."
                        tofu apply -auto-approve tfplan
                        echo ""
                        echo "‚úÖ Infraestructura actualizada exitosamente"
                    '''
                }
            }
        }
        
        stage('üìã Mostrar Outputs') {
            steps {
                echo '=== Mostrando informaci√≥n de infraestructura creada ==='
                dir("${TOFU_DIR}") {
                    sh '''
                        echo "üìä Outputs de la infraestructura:"
                        echo ""
                        tofu output
                        echo ""
                        echo "‚úÖ Informaci√≥n de infraestructura disponible"
                    '''
                }
            }
        }
    }
    
    post {
        success {
            echo '‚úÖ ¬°Infraestructura desplegada exitosamente!'
            echo ''
            echo 'üìã Resumen del Despliegue:'
            echo '   ‚úì Autenticaci√≥n GCP completada'
            echo '   ‚úì OpenTofu inicializado'
            echo '   ‚úì Plan generado y validado'
            echo '   ‚úì Cambios aplicados autom√°ticamente'
            echo ''
            echo 'üéØ Infraestructura lista para uso'
        }
        failure {
            echo '‚ùå Error al desplegar infraestructura'
            echo 'üí° Revisa los logs para identificar el problema'
            echo ''
            echo 'üîß Posibles causas:'
            echo '   ‚Ä¢ Credenciales GCP inv√°lidas'
            echo '   ‚Ä¢ Errores en sintaxis HCL'
            echo '   ‚Ä¢ Recursos ya existentes'
            echo '   ‚Ä¢ Cuotas de GCP excedidas'
        }
        always {
            echo "=== Pipeline IaC Build #${BUILD_NUMBER} finalizado ==="
        }
    }
}]]></script>
    <sandbox>true</sandbox>
  </definition>
  <triggers/>
  <disabled>false</disabled>
</flow-definition>
