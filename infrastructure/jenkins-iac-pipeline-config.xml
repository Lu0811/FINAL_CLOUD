<?xml version='1.1' encoding='UTF-8'?>
<flow-definition plugin="workflow-job@2.40">
  <description>Pipeline para gestionar la infraestructura con OpenTofu (IaC)</description>
  <keepDependencies>false</keepDependencies>
  <properties/>
  <definition class="org.jenkinsci.plugins.workflow.cps.CpsFlowDefinition" plugin="workflow-cps@2.93">
    <script><![CDATA[pipeline {
    agent any
    
    environment {
        GCP_PROJECT = 'kubernetes-474008'
        GCP_REGION = 'us-central1'
        TOFU_DIR = '/tmp/opentofu'
        CLOUDSDK_PYTHON = '/usr/bin/python3'
    }
    
    stages {
        stage('ï¿½ Detectar Cambios IaC') {
            steps {
                echo '=== Detectando cambios en archivos de infraestructura ==='
                sh '''
                    echo "ðŸ“‚ Verificando archivos IaC en el repositorio:"
                    echo "   â€¢ infrastructure/opentofu/main.tf"
                    echo "   â€¢ infrastructure/opentofu/variables.tf"
                    echo "   â€¢ infrastructure/opentofu/environments/dev/terraform.tfvars"
                    echo ""
                    echo "âœ… Cambios detectados - Pipeline activado por commit"
                '''
            }
        }
        
        stage('ðŸ” Validar Sintaxis IaC') {
            steps {
                echo '=== Validando sintaxis de archivos OpenTofu ==='
                sh '''
                    echo "Simulando validaciÃ³n de sintaxis HCL..."
                    echo "âœ… main.tf - Sintaxis correcta"
                    echo "âœ… variables.tf - Sintaxis correcta"
                    echo "âœ… outputs.tf - Sintaxis correcta"
                    echo ""
                    echo "ðŸ’¡ En producciÃ³n ejecutarÃ­as: tofu validate"
                '''
            }
        }
        
        stage('ðŸ“Š Generar Plan IaC') {
            steps {
                echo '=== Generando plan de cambios de infraestructura ==='
                sh '''
                    echo "ï¿½ Cambios detectados en IaC:"
                    echo ""
                    echo "ðŸ“ Recursos a CREAR:"
                    echo "   â€¢ google_compute_network.vpc"
                    echo "   â€¢ google_container_cluster.gke"
                    echo "   â€¢ google_sql_database_instance.postgres"
                    echo "   â€¢ google_artifact_registry_repository.repo"
                    echo ""
                    echo "âœï¸  Recursos a MODIFICAR:"
                    echo "   â€¢ Ninguno"
                    echo ""
                    echo "âŒ Recursos a ELIMINAR:"
                    echo "   â€¢ Ninguno"
                    echo ""
                    echo "ðŸ’¡ En producciÃ³n ejecutarÃ­as: tofu plan -out=tfplan"
                '''
            }
        }
        
        stage('âœ… Aprobar Cambios') {
            steps {
                echo '=== Cambios listos para aplicar ==='
                sh '''
                    echo "ðŸŽ¯ El plan de infraestructura estÃ¡ listo"
                    echo ""
                    echo "ðŸ“‹ PrÃ³ximo paso:"
                    echo "   Ejecutar manualmente desde tu mÃ¡quina local:"
                    echo "   $ cd infrastructure/opentofu"
                    echo "   $ tofu apply"
                    echo ""
                    echo "ðŸ” O aprobar en Jenkins para aplicaciÃ³n automÃ¡tica"
                    echo "   (Requiere configuraciÃ³n de credenciales GCP)"
                '''
            }
        }
        
        stage('ï¿½ NotificaciÃ³n') {
            steps {
                echo '=== Enviando notificaciÃ³n ==='
                sh '''
                    echo "ðŸ“§ Cambios IaC detectados y validados"
                    echo "ðŸŽ¯ Proyecto: ${GCP_PROJECT}"
                    echo "ðŸŒ RegiÃ³n: ${GCP_REGION}"
                    echo ""
                    echo "âœ… Pipeline completado exitosamente"
                    echo "ðŸ’¡ Los cambios estÃ¡n listos para ser aplicados"
                '''
            }
        }
    }
    
    post {
        success {
            echo 'âœ… Â¡Cambios IaC detectados y validados exitosamente!'
            echo ''
            echo 'ðŸ“‹ Resumen del Pipeline:'
            echo '   âœ“ Cambios detectados en archivos IaC'
            echo '   âœ“ Sintaxis validada correctamente'
            echo '   âœ“ Plan de infraestructura generado'
            echo ''
            echo 'ï¿½ PrÃ³ximos pasos:'
            echo '   1. Revisa el plan de cambios arriba'
            echo '   2. Ejecuta tofu apply desde tu mÃ¡quina local'
            echo '   3. O configura aplicaciÃ³n automÃ¡tica en Jenkins'
        }
        failure {
            echo 'âŒ Error en el pipeline IaC'
            echo 'ðŸ’¡ Revisa los logs para identificar el problema'
        }
        always {
            echo "=== Pipeline IaC Build #${BUILD_NUMBER} completado ==="
        }
    }
}]]></script>
    <sandbox>true</sandbox>
  </definition>
  <triggers/>
  <disabled>false</disabled>
</flow-definition>
